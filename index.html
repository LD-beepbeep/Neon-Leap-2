<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Neon Leap 2</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap'); /* Retro Font for Studio */
  
  :root {
    --c-bg: #05070a;
    --c-primary: #00f1ff;
    --c-accent: #ffe900;
    --c-danger: #ff0055;
    --c-rare: #a020f0;
    --c-fire: #ff6600;
    --c-skip: #888;
    --c-success: #00ffaa;
    --font-main: 'Rajdhani', sans-serif;
  }
  
  /* LIGHT MODE VARIABLES */
  body.light-mode {
      --c-bg: #e0e5ec;
      --c-primary: #0077cc;
      --c-accent: #dcb000;
      --c-danger: #d90048;
      --c-success: #00aa70;
  }

  html,body { margin:0; padding:0; width:100%; height:100%; background:var(--c-bg); overflow:hidden; font-family:var(--font-main); user-select:none; -webkit-user-select:none; transition: background 0.3s; }
  #game { position:relative; width:100%; height:100%; cursor:crosshair; }
  canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
  #bg-canvas { z-index:0; }
  #game-canvas { z-index:10; }
  
  /* --- HUD --- */
  .ui-layer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:20; pointer-events:none; }
  
  .hud-top {
      position: absolute; top: 0; left: 0; width: 100%; padding: 20px;
      pointer-events: none;
  }

  .hud-widget {
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(8px);
      padding: 8px 25px;
      border-radius: 6px;
      color: #fff; font-weight: 800; font-size: 1.5rem;
      display: flex; align-items: center; gap: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
      transform: skewX(-10deg);
      pointer-events: auto;
  }
  body.light-mode .hud-widget { background: rgba(255, 255, 255, 0.8); border-color: rgba(0,0,0,0.1); color: #333; }
  
  .hud-widget span { transform: skewX(10deg); display:inline-block; }
  .hud-money { display: none; } 
  
  .hud-level { 
      position: absolute; top: 20px; left: 20px;
      border-left: 4px solid var(--c-primary); color: var(--c-primary); 
  }
  
  .hud-streak { 
      position: absolute; top: 80px; left: 20px;
      border-bottom: 4px solid var(--c-fire); color: var(--c-fire); 
      display: none; 
  } 
  
  .hud-timer { 
      border-bottom: 4px solid var(--c-danger); color: #fff; 
      font-family: monospace; letter-spacing: 2px; 
      display: none; 
      position: absolute; left: 50%; transform: translateX(-50%); top: 20px;
  }
  body.light-mode .hud-timer { color: #333; }
  
  .hud-score { border-bottom: 4px solid var(--c-rare); color: #fff; display:none; }
  body.light-mode .hud-score { color: #333; }

  #prog-container {
      position: absolute; top: 0; left: 0; width: 100%; height: 6px;
      background: rgba(255,255,255,0.1); z-index: 25; display: none;
  }
  body.light-mode #prog-container { background: rgba(0,0,0,0.1); }
  #prog-bar {
      height: 100%; background: var(--c-primary); width: 0%;
      box-shadow: 0 0 10px var(--c-primary); transition: width 0.1s linear;
  }

  .hud-pause {
      pointer-events: auto; cursor: pointer;
      background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.2);
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight:bold; transition: 0.2s;
      position: absolute; right: 20px; top: 20px; 
  }
  body.light-mode .hud-pause { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.2); color: #333; }
  .hud-pause:hover { border-color: var(--c-primary); color: var(--c-primary); background: #fff; }

  #hud-skip {
      pointer-events: auto;
      position: absolute; bottom: 40px; right: 20px;
      background: rgba(255, 0, 85, 0.2); border: 2px solid var(--c-danger);
      color: #fff; padding: 15px 30px; font-weight: 800; cursor: pointer;
      border-radius: 4px; display: none; 
      animation: pulseBtn 2s infinite; backdrop-filter: blur(5px);
      text-transform: uppercase; letter-spacing: 2px; font-size: 1.2rem;
      box-shadow: 0 0 20px rgba(255, 0, 85, 0.4);
  }
  body.light-mode #hud-skip { color: #fff; background: var(--c-danger); }
  #hud-skip:hover { background: var(--c-danger); transform: scale(1.05); }
  @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

  .hud-abilities { display: none !important; }

  #start-overlay {
      position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
      font-size: 8rem; color: #fff; font-weight: 900; font-style: italic;
      text-shadow: 0 0 30px var(--c-primary); pointer-events: none; opacity: 0;
      transition: opacity 0.2s, transform 0.2s; z-index: 50;
  }
  body.light-mode #start-overlay { color: #333; text-shadow: 0 0 30px rgba(0,0,0,0.2); }

  /* OVERLAYS */
  .overlay-menu {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.85); z-index: 60; pointer-events: auto;
      backdrop-filter: blur(10px);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  body.light-mode .overlay-menu { background: rgba(255,255,255,0.95); }
  
  .win-title { font-size: 3rem; color: #fff; font-weight: 900; font-style: italic; text-transform: uppercase; margin-bottom: 10px; }
  body.light-mode .win-title { color: #333; }
  .win-subtitle { font-size: 1.5rem; color: #888; font-weight: bold; margin-bottom: 20px; letter-spacing: 2px; }
  .win-time { font-size: 5rem; color: var(--c-primary); font-family: monospace; font-weight: bold; margin-bottom: 20px; text-shadow: 0 0 30px var(--c-primary); }
  .new-record-anim { animation: pulseRecord 0.5s infinite alternate; color: var(--c-accent); font-size: 2rem; font-weight: bold; margin-bottom: 20px; letter-spacing: 5px; }
  @keyframes pulseRecord { from { transform: scale(1); text-shadow: 0 0 10px var(--c-accent); } to { transform: scale(1.2); text-shadow: 0 0 30px var(--c-accent); } }

  .chal-pop {
      position: absolute; top: 150px; right: -300px;
      background: rgba(0,0,0,0.9); border: 1px solid var(--c-accent); padding: 15px 25px; color: #fff;
      display: flex; align-items: center; gap: 15px; z-index: 50; transition: right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-radius: 8px 0 0 8px; box-shadow: -5px 5px 20px rgba(0,0,0,0.5);
  }
  .chal-pop.show { right: 0; }
  .chal-icon { font-size: 2rem; }
  .chal-info div:first-child { color: var(--c-accent); font-weight: bold; font-size: 0.8rem; letter-spacing: 1px; }
  .chal-info div:last-child { font-weight: bold; font-size: 1.1rem; }

  /* CARDS */
  .chal-card {
      background: linear-gradient(135deg, #151922, #0d1015);
      border: 1px solid #333; border-radius: 12px; padding: 20px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4); position: relative; overflow: hidden;
      margin-bottom: 15px; transition: transform 0.2s;
  }
  body.light-mode .chal-card { background: linear-gradient(135deg, #fff, #f0f0f5); border-color: #ddd; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  .chal-card:hover { transform: translateY(-2px); border-color: #555; }
  .chal-card.done { border-color: var(--c-accent); background: linear-gradient(135deg, rgba(255, 233, 0, 0.05), #0d1015); }
  body.light-mode .chal-card.done { background: linear-gradient(135deg, rgba(255, 233, 0, 0.1), #fff); }
  .chal-progress-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.1); }
  body.light-mode .chal-progress-bg { background: rgba(0,0,0,0.1); }
  .chal-progress-fill { height: 100%; background: var(--c-primary); transition: width 0.5s; }
  .chal-card.done .chal-progress-fill { background: var(--c-accent); }
  .chal-icon-box { font-size: 2.5rem; margin-right: 20px; min-width: 60px; text-align: center; }
  .chal-text { text-align: left; flex: 1; }
  .chal-title { font-weight: 800; font-size: 1.4rem; margin-bottom: 4px; color: #fff; text-transform: uppercase; font-style: italic; }
  body.light-mode .chal-title { color: #222; }
  .chal-desc { color: #888; font-size: 0.9rem; }
  .chal-meta { text-align: right; min-width: 120px; }
  .chal-status { font-weight: bold; font-size: 1.2rem; color: #fff; }
  body.light-mode .chal-status { color: #333; }
  .chal-reward { color: var(--c-accent); font-weight: bold; font-size: 1rem; margin-top: 5px; }

  /* STUDIO PIXEL ART STYLE */
  .studio-box {
      grid-column: 1/-1;
      background: #111;
      border: 4px solid #333;
      padding: 20px;
      font-family: 'VT323', monospace;
      color: #0f0; /* Retro Terminal Green */
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
  }
  body.light-mode .studio-box { background: #eee; border-color: #999; color: #000; }
  
  .studio-header { font-size: 2rem; text-align: center; border-bottom: 2px dashed #333; margin-bottom: 20px; padding-bottom: 10px; }
  .pixel-grid { 
      display: grid; grid-template-columns: repeat(6, 1fr); gap: 2px; width: 240px; margin: 0 auto; 
      background: #222; padding: 5px; border: 2px solid #555; position: relative;
  }
  body.light-mode .pixel-grid { background: #ddd; border-color: #bbb; }
  .pixel-cell { width: 35px; height: 35px; background: #000; cursor: pointer; transition: 0.0s; }
  .pixel-cell:hover { box-shadow: inset 0 0 0 2px rgba(255,255,255,0.5); }
  
  /* EYE GUIDES IN STUDIO */
  .eye-guide {
      pointer-events: none; position: absolute; background: rgba(255,255,255,0.3); border: 1px solid rgba(0,0,0,0.2);
  }
  
  .studio-controls { margin-top: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  .color-swatch { width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
  .color-swatch.active { border-color: #fff; transform: scale(1.2); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
  body.light-mode .color-swatch.active { border-color: #000; box-shadow: 0 0 10px rgba(0,0,0,0.5); }

  .studio-locked { 
      grid-column: 1/-1; text-align: center; padding: 40px; 
      background: repeating-linear-gradient(45deg, #111, #111 10px, #1a1a1a 10px, #1a1a1a 20px);
      border: 2px solid var(--c-danger); color: var(--c-danger); font-weight: bold; font-size: 1.5rem;
  }
  body.light-mode .studio-locked { background: repeating-linear-gradient(45deg, #ddd, #ddd 10px, #eee 10px, #eee 20px); }
  
  /* MINI PREVIEW GRID */
  #mini-grid-prev {
      display: grid; grid-template-columns: repeat(6, 1fr); width: 80px; height: 80px;
      margin: 10px auto; border: 2px solid #555;
  }

  .menu-screen {
      position: absolute; top:0; left:0; width:100%; height:100%; 
      background: rgba(5, 7, 10, 0.96); z-index: 100; pointer-events: auto;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.3s; opacity: 0; pointer-events: none;
      backdrop-filter: blur(20px);
  }
  body.light-mode .menu-screen { background: rgba(230, 235, 240, 0.96); }
  .menu-screen.active { opacity: 1; pointer-events: auto; }
  
  .menu-content { 
      width: 100%; max-width: 1000px; height: 100%; overflow-y: auto;
      padding: 40px; text-align: center; box-sizing: border-box;
      display: flex; flex-direction: column; align-items: center;
  }
  .menu-content::-webkit-scrollbar { width: 8px; }
  .menu-content::-webkit-scrollbar-track { background: #111; }
  .menu-content::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
  .menu-content::-webkit-scrollbar-thumb:hover { background: var(--c-primary); }

  h1 { font-size: 5rem; margin: 0; color: #fff; text-transform: uppercase; font-style: italic; line-height: 0.8; letter-spacing: -4px; text-shadow: 5px 5px 0px rgba(0, 241, 255, 0.2); transform: skewX(-5deg); margin-bottom: 20px; }
  body.light-mode h1 { color: #222; text-shadow: 5px 5px 0px rgba(0, 119, 204, 0.2); }
  h1 span { color: var(--c-primary); }
  h2 { font-size: 1.5rem; color: #667; margin-bottom: 30px; letter-spacing: 5px; text-transform: uppercase; font-weight: 600; }
  
  .btn {
      background: linear-gradient(90deg, #1a1a1a, #111);
      border: 1px solid #333; color: #fff; padding: 25px 50px;
      font-size: 1.5rem; line-height: 1.2;
      font-family: inherit; font-weight: 800; cursor: pointer;
      position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 2px;
      clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
      transition: 0.2s; margin: 15px; min-width: 300px;
      display: inline-flex; justify-content: center; align-items: center;
  }
  body.light-mode .btn { background: linear-gradient(90deg, #fff, #eee); border-color: #ccc; color: #333; }
  .btn:hover { background: #fff; color: #000; transform: scale(1.05) skewX(-5deg); box-shadow: 0 0 30px rgba(255,255,255,0.3); }
  .btn-primary { border-color: var(--c-primary); color: var(--c-primary); }
  .btn-primary:hover { background: var(--c-primary); color: #000; box-shadow: 0 0 40px var(--c-primary); }
  .btn-danger { border-color: var(--c-danger); color: var(--c-danger); }
  .btn-danger:hover { background: var(--c-danger); color: #fff; box-shadow: 0 0 40px var(--c-danger); }
  .btn-rare { border-color: var(--c-rare); color: var(--c-rare); }
  .btn-rare:hover { background: var(--c-rare); color: #fff; box-shadow: 0 0 40px var(--c-rare); }
  .btn-accent { border-color: var(--c-accent); color: var(--c-accent); }
  .btn-accent:hover { background: var(--c-accent); color: #000; box-shadow: 0 0 40px var(--c-accent); }

  .mode-select { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 40px; }
  .mode-card { width: 200px; padding: 20px; border: 1px solid #333; background: #0b0e14; border-radius: 8px; text-align: left; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; gap: 10px; position: relative; }
  body.light-mode .mode-card { background: #fff; border-color: #ddd; }
  .mode-card:hover { border-color: var(--c-primary); transform: translateY(-5px); }
  .mode-card h3 { margin: 0; color: #fff; font-size: 1.2rem; }
  body.light-mode .mode-card h3 { color: #222; }
  .mode-card p { margin: 0; color: #666; font-size: 0.9rem; }

  .stats-container { width: 100%; max-width: 900px; text-align: left; }
  .stats-header { border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
  body.light-mode .stats-header { border-color: #ddd; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; width: 100%; margin-bottom: 40px; }
  .stat-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 4px; border-left: 3px solid #333; }
  body.light-mode .stat-card { background: #fff; border-color: #ccc; }
  .stat-card.highlight { border-color: var(--c-accent); background: rgba(255, 233, 0, 0.05); }
  body.light-mode .stat-card.highlight { background: rgba(255, 233, 0, 0.1); }
  .stat-val { font-size: 2rem; font-weight: 800; color: #fff; }
  body.light-mode .stat-val { color: #333; }
  .stat-label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-top: 5px; }
  .records-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; padding-right: 10px; }
  .record-item { background: #111; padding: 10px 15px; display: flex; justify-content: space-between; border-radius: 4px; border: 1px solid #222; font-family: monospace; }
  body.light-mode .record-item { background: #fff; border-color: #ddd; }
  .record-item span:first-child { color: #888; }
  .record-item span:last-child { color: var(--c-primary); font-weight: bold; }

  .shop-container { width: 100%; max-width: 900px; }
  .shop-nav { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
  .shop-tab { background: none; border: none; color: #666; font-size: 1.2rem; font-weight: bold; cursor: pointer; text-transform: uppercase; padding: 5px 15px; transition: 0.2s; }
  .shop-tab:hover { color: #fff; }
  body.light-mode .shop-tab:hover { color: #000; }
  .shop-tab.active { color: var(--c-primary); border-bottom: 2px solid var(--c-primary); }

  .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; width: 100%; padding-bottom: 50px; }
  .shop-card { background: rgba(20, 25, 35, 0.6); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; align-items: center; transition: 0.2s; position: relative; }
  body.light-mode .shop-card { background: #fff; border-color: #ddd; }
  .shop-card:hover { transform: translateY(-5px); background: rgba(30, 35, 45, 0.8); border-color: #fff; }
  body.light-mode .shop-card:hover { background: #f9f9f9; border-color: #bbb; }
  .shop-card.owned { border-color: #00ffaa; box-shadow: 0 0 5px rgba(0,255,170,0.1); }
  .shop-card.selected { border: 2px solid var(--c-primary); background: rgba(0, 241, 255, 0.05); }
  .card-preview { width: 50px; height: 50px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
  .card-btn { width: 100%; padding: 8px 0; border: none; font-weight: 800; cursor: pointer; margin-top: 10px; border-radius: 4px; }
  .card-btn.buy { background: var(--c-accent); color: #000; }
  
  .coupon-area { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; width: 100%; }
  .coupon-input { background: #111; border: 1px solid #333; color: #fff; padding: 10px 15px; font-family: inherit; font-weight: bold; text-transform: uppercase; width: 200px; }
  body.light-mode .coupon-input { background: #fff; border-color: #ccc; color: #000; }
  .coupon-btn { background: #333; color: #fff; border: none; padding: 0 20px; cursor: pointer; font-weight: bold; }
  body.light-mode .coupon-btn { background: #ddd; color: #000; }
  .coupon-btn:hover { background: var(--c-primary); color: #000; }

  .level-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; width: 100%; max-width: 900px; padding-bottom: 40px; }
  .lvl-btn { width: 70px; height: 70px; background: #111; border: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; border-radius: 4px; cursor: default; transition: 0.2s; font-weight: bold; position: relative; }
  body.light-mode .lvl-btn { background: #fff; border-color: #ccc; color: #aaa; }
  .lvl-num { font-size: 1.4rem; }
  .lvl-time { font-size: 0.7rem; margin-top: 2px; color: var(--c-primary); font-family: monospace; }
  
  /* UPDATED LEVEL STATUS COLORS */
  .lvl-btn.unlocked { color: #fff; border-color: var(--c-primary); cursor: pointer; background: rgba(0, 241, 255, 0.1); }
  body.light-mode .lvl-btn.unlocked { color: #333; background: #fff; border-color: var(--c-primary); }
  
  .lvl-btn.completed { border-color: var(--c-success); color: var(--c-success); background: rgba(0, 255, 170, 0.1); }
  body.light-mode .lvl-btn.completed { background: rgba(0, 255, 170, 0.2); border-color: var(--c-success); color: #005530; }
  
  .lvl-btn.skipped { border-color: var(--c-skip); color: var(--c-skip); background: rgba(255, 255, 255, 0.05); }
  body.light-mode .lvl-btn.skipped { background: #eee; border-color: #999; color: #777; }

  /* TOGGLE LIGHT MODE BTN */
  .theme-toggle { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 2rem; cursor: pointer; color: #fff; z-index: 150; }
  body.light-mode .theme-toggle { color: #333; }
  
  #mobile { display:none; position:absolute; bottom:0; left:0; width:100%; height:100%; z-index:50; pointer-events:none; }
  .t-btn { pointer-events:auto; position:absolute; width:75px; height:75px; border:2px solid rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.6); font-size:30px; backdrop-filter:blur(5px); transition: 0.1s; }
  .t-btn:active { background: #fff; color: #000; opacity: 0.8; }
  #mb-l { bottom: 30px; left: 30px; }
  #mb-r { bottom: 30px; left: 125px; }
  #mb-j { bottom: 30px; right: 30px; width: 90px; height: 90px; border-color: rgba(255, 233, 0, 0.4); color: var(--c-accent); }
  #mb-d { bottom: 140px; right: 30px; border-color: rgba(255, 0, 85, 0.4); color: var(--c-danger); }
  
  @media (hover: none) and (pointer: coarse) { #mobile { display: block; } }
  @media(max-width:800px){ h1{font-size:3rem;} .shop-grid{grid-template-columns: 1fr 1fr;} }
</style>
</head>
<body>

<div id="game">
  <canvas id="bg-canvas"></canvas>
  <canvas id="game-canvas"></canvas>
  
  <!-- HUD -->
  <div id="ui" class="ui-layer" style="display:none;">
    <div id="prog-container"><div id="prog-bar"></div></div>
    
    <div class="hud-top">
        <div class="hud-widget hud-money"><span>‚Ç≥</span> <span id="val-money">0</span></div>
        <div class="hud-widget hud-score" id="hud-score">0m</div>
        <div class="hud-widget hud-timer" id="hud-timer">00:00</div>
        <div class="hud-widget hud-streak" id="hud-streak">üî• <span id="val-streak">0</span></div>
        <div class="hud-widget hud-level" id="hud-lvl-box"><span id="val-level">1</span> <span>LVL</span></div>
    </div>
    
    <div class="hud-pause" onclick="Game.togglePause()">||</div>
    
    <!-- SKIP BUTTON -->
    <div id="hud-skip" onclick="Game.skipLevel()">SKIP LEVEL &gt;&gt;</div>
    
    <div id="start-overlay">GO!</div>
    
    <!-- Pause Menu Overlay -->
    <div id="pause-menu" class="overlay-menu" style="display:none;">
        <h2 style="color:var(--c-primary); font-size:4rem; margin-bottom:40px; text-shadow:0 0 20px var(--c-primary)">PAUSED</h2>
        <button class="btn btn-primary" onclick="Game.togglePause()">RESUME</button>
        <button class="btn btn-rare" onclick="Game.retryLevel(); Game.togglePause();">RETRY</button>
        <button class="btn btn-danger" onclick="Game.menu()">EXIT TO MENU</button>
    </div>

    <!-- Win / Record Menu Overlay -->
    <div id="win-menu" class="overlay-menu" style="display:none;">
        <div id="win-new-record" class="new-record-anim" style="display:none;">NEW RECORD!</div>
        <div class="win-title">LEVEL COMPLETE</div>
        <div id="win-level-num" class="win-subtitle">LEVEL 1</div>
        <div id="win-time-val" class="win-time">00:00</div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-rare" onclick="Game.retryLevel()">RETRY (R)</button>
            <button class="btn btn-primary" onclick="Game.nextLevel()">NEXT LEVEL (S)</button>
        </div>
        <button class="btn" style="margin-top:0; min-width:auto; padding:15px 30px" onclick="Game.menu()">MENU</button>
    </div>
    
    <!-- Game Complete Menu -->
    <div id="victory-menu" class="overlay-menu" style="display:none;">
        <h2 style="color:var(--c-accent); font-size:5rem; margin-bottom:10px; text-shadow:0 0 30px var(--c-accent)">VICTORY!</h2>
        <div class="win-subtitle" style="color:#fff">ALL LEVELS COMPLETED</div>
        <div class="stats-grid" style="width:100%; max-width:600px; margin-bottom:30px;">
             <div class="stat-card"><div class="stat-val" id="vic-death">0</div><div class="stat-label">DEATHS</div></div>
             <div class="stat-card"><div class="stat-val" id="vic-time">0s</div><div class="stat-label">TIME</div></div>
             <div class="stat-card"><div class="stat-val" id="vic-skip">0</div><div class="stat-label">SKIPPED</div></div>
        </div>
        <button class="btn btn-primary" onclick="Game.downloadStats()">DOWNLOAD STATS</button>
        <button class="btn btn-danger" onclick="Game.menu()">MAIN MENU</button>
    </div>
    
    <!-- Endless Game Over Menu -->
    <div id="endless-menu" class="overlay-menu" style="display:none;">
        <h2 style="color:var(--c-danger); font-size:4rem; margin-bottom:10px; text-shadow:0 0 20px var(--c-danger)">GAME OVER</h2>
        <div class="win-subtitle" style="color:#fff">DISTANCE RUN</div>
        <div id="endless-score-val" class="win-time" style="color:#fff">0m</div>
        <div id="endless-best-val" style="color:var(--c-accent); font-weight:bold; font-size:1.5rem; margin-bottom:30px">BEST: 0m</div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="Game.retryLevel()">RETRY</button>
            <button class="btn btn-danger" onclick="Game.menu()">QUIT</button>
        </div>
    </div>

    <div id="chal-pop" class="chal-pop">
        <div class="chal-icon">üèÜ</div>
        <div class="chal-info">
            <div>CHALLENGE COMPLETE</div>
            <div id="chal-name">First Blood</div>
        </div>
    </div>
  </div>

  <!-- MOBILE -->
  <div id="mobile">
    <div id="mb-l" class="t-btn">‚Üê</div>
    <div id="mb-r" class="t-btn">‚Üí</div>
    <div id="mb-j" class="t-btn">‚Üë</div>
    <div id="mb-d" class="t-btn">‚ö°</div>
  </div>

  <!-- MENU -->
  <div id="menu" class="menu-screen active">
    <div class="menu-content" id="menu-content"></div>
  </div>
</div>

<script>
// --- CONFIGURATION ---
var CFG = {
    G: 0.6, MAX_G: 12, FRIC: 0.85, AIR_FRIC: 0.95, ACC: 1.2, MAX_S: 9,
    JUMP: -13, DASH: 22, WALL_SLIDE: 2, WALL_JUMP: {x: 10, y: -12},
    COYOTE: 10, BUFFER: 8, TILE: 40, MAX_LEVELS: 300
};

// --- DATA ---
var DB = {
    skins: [
        {n:"Default", c:"#ffe900", p:0},
        {n:"Neon", c:"#00f1ff", p:500},
        {n:"Crimson", c:"#ff0055", p:1000},
        {n:"Biohazard", c:"#ccff00", p:2500, glow:1},
        {n:"Ninja", c:"#333", b:"#555", p:4000},
        {n:"Ghost", c:"rgba(255,255,255,0.4)", b:"#fff", p:6000},
        {n:"Midas", c:"#ffd700", glow:1, p:10000},
        {n:"Cyclops", c:"#f80", eye:1, p:12000},
        {n:"Inferno", c:"#ff4400", glow:1, p:15000},
        {n:"Emoji", c:"#ff0", eye:1, b:"#000", p:18000},
        {n:"Void", c:"#000", b:"#fff", glow:1, p:50000},
        {n:"Demon", c:"#600", b:"#f00", eye:1, p:75000}
    ],
    upgrades: [
        {id:"double", n:"Double Jump", d:"Jump again in mid-air", p:2500, passive:true},
        {id:"dash", n:"Phase Dash", d:"Shift/X to Dash", p:3500, ic:"‚ö°", active:true},
        {id:"magnet", n:"Coin Magnet", d:"Attracts coins", p:4000, passive:true},
        {id:"climb", n:"Wall Climb", d:"Climb walls", p:5000, passive:true},
        {id:"stomp", n:"Super Stomp", d:"Down to smash", p:7000, passive:true},
        {id:"chrono", n:"Chrono Shift", d:"Press C to slow time", p:25000, active:true},
        {id:"sonic", n:"Sonic Boom", d:"Speed destroys enemies", p:18000, passive:true},
        {id:"glider", n:"Glider", d:"Hold Jump to glide", p:15000, passive:true},
        {id:"customizer", n:"Designer License", d:"Unlocks Skin Studio", p:50000, ic:"üé®", special:true}
    ],
    backgrounds: [
        {id:0, n:"Classic", p:0},
        {id:1, n:"Grid", p:5000},
        {id:2, n:"Starfield", p:10000},
        {id:3, n:"Sunset", p:20000}
    ],
    challenges: [
        {id:"jump1k", n:"Bunny Hopper", d:"Jump 1000 times", goal:1000, stat:"jumps", r:500, ic:"üêá"},
        {id:"run10k", n:"Marathon Runner", d:"Run 10,000m total", goal:10000, stat:"distance", r:1000, ic:"üèÉ"},
        {id:"coin500", n:"Treasure Hunter", d:"Collect 500 coins", goal:500, stat:"coins", r:2000, ic:"üí∞"},
        {id:"death50", n:"Determination", d:"Die 50 times", goal:50, stat:"deaths", r:1000, ic:"üíÄ"},
        {id:"endless500", n:"Survivor", d:"Reach 500m in Endless", goal:500, stat:"maxEndless", r:3000, ic:"üõ°Ô∏è"},
        {id:"levels20", n:"Explorer", d:"Unlock 20 levels", goal:20, stat:"unlocked", r:5000, ic:"üó∫Ô∏è"}
    ]
};

// Initial grid for custom skin: 6x6 grid of default yellow
const DEFAULT_GRID = new Array(36).fill("#ffe900");

var Save = { 
    money:0, level:0, maxLvl:0, skin:0, bg:0, skins:[0], bgs:[0], ups:{}, 
    stats:{jumps:0, distance:0, deaths:0, coins:0, maxEndless:0, unlocked:1},
    chals:[], times:{}, codes:[], skipped:[],
    daily: { date: "", tasks: [] },
    light: false,
    customSkin: { type: 'grid', pixels: DEFAULT_GRID }
};

try { 
    let s=localStorage.getItem('nl20_ultimate'); 
    if(s) {
        let loaded = JSON.parse(s);
        // Migration logic for older saves or different structure
        if(!loaded.customSkin || !loaded.customSkin.pixels) loaded.customSkin = { type: 'grid', pixels: DEFAULT_GRID };
        Save = Object.assign(Save, loaded);
        if(!Save.bgs) Save.bgs = [0];
        if(!Save.skipped) Save.skipped = [];
    }
} catch(e){}

const save = () => {
    Save.stats.unlocked = Save.maxLvl + 1;
    localStorage.setItem('nl20_ultimate', JSON.stringify(Save));
};

const DAILY_DEFS = [
    { id: 0, n: "Coin Collector", d: "Collect 50 coins today", goal: 50, r: 500, stat: "coins", ic: "ü™ô" },
    { id: 1, n: "Level Master", d: "Complete 5 levels today", goal: 5, r: 800, stat: "levels", ic: "üèÜ" },
    { id: 2, n: "Death Defier", d: "Die 10 times today", goal: 10, r: 300, stat: "deaths", ic: "üíÄ" },
    { id: 3, n: "Speed Demon", d: "Dash 20 times today", goal: 20, r: 400, stat: "dashes", ic: "‚ö°" },
    { id: 4, n: "High Jumper", d: "Jump 100 times today", goal: 100, r: 400, stat: "jumps", ic: "üêá" }
];

const checkDaily = () => {
    let today = new Date().toDateString();
    if(Save.daily.date !== today) {
        Save.daily.date = today;
        let indices = [];
        while(indices.length < 2) {
            let r = Math.floor(Math.random() * DAILY_DEFS.length);
            if(indices.indexOf(r) === -1) indices.push(r);
        }
        Save.daily.tasks = indices.map(id => ({ id: id, p: 0, c: false }));
        save();
    }
};
checkDaily();

if(Save.light) document.body.classList.add('light-mode');

// --- ENGINE ---
var cvs = document.getElementById('game-canvas');
var ctx = cvs.getContext('2d');
var bgCvs = document.getElementById('bg-canvas');
var bgCtx = bgCvs.getContext('2d');

var MODE = { NORMAL: 0, TIME: 1, ENDLESS: 2 };
var currentMode = MODE.NORMAL;
var state = 'MENU';
var paused = false; 
var cam = {x:0, y:0};
var map = {w:0, h:0, d:[], o:[]}; 
var parts = [];
var texts = []; 
var shake = 0;
var frame = 0;
var lastTime = 0;
var endX = 0;
var endlessScore = 0;
var gameTimer = 0; 
var currentStreak = 0; 
var deathsInLevel = 0;

var In = { k:{}, prevK:{}, init(){
    window.addEventListener('keydown', e => {
        In.k[e.code]=true;
        if(e.code === 'KeyR' && state === 'PLAY' && !paused) die();
        if(state === 'WIN') {
            if(e.code === 'KeyR') Game.retryLevel();
            if(e.code === 'KeyS') Game.nextLevel();
        }
        if(e.code === 'Escape') Game.togglePause();
    });
    window.addEventListener('keyup', e => In.k[e.code]=false);
    
    document.addEventListener("visibilitychange", () => {
        if (document.hidden && state === 'PLAY' && !paused) {
            Game.togglePause();
        }
    });
    
    const t = (id,k) => {
        let el=document.getElementById(id);
        if(el) {
            el.addEventListener('touchstart', e=>{ e.preventDefault(); In.k[k]=true; });
            el.addEventListener('touchend', e=>{ e.preventDefault(); In.k[k]=false; });
        }
    };
    t('mb-l','ArrowLeft'); t('mb-r','ArrowRight'); t('mb-j','ArrowUp'); t('mb-d','KeyX');
}};

var P = {
    x:0, y:0, w:30, h:30, vx:0, vy:0,
    ground:false, wall:0, jumps:0,
    dead:false, dTime:0, dCool:0,
    shield:false, coyote:0, buffer:0, invincible:0,
    chronoActive: false, chronoTimer: 0, chronoCooldown: 0,
    
    reset(x,y) {
        this.x=x; this.y=y; this.vx=0; this.vy=0;
        this.dead=false; this.dTime=0; this.invincible=0;
        this.jumps = Save.ups.double ? 1 : 0;
        this.chronoActive = false; this.chronoTimer = 0; this.chronoCooldown = 0;
    },
    
    update(dt) {
        if(this.dead) return;
        let timeScale = 1.0;
        
        if(Save.ups.chrono) {
            let cKey = In.k['KeyC'];
            if(cKey && this.chronoCooldown <= 0 && !this.chronoActive) {
                this.chronoActive = true;
                this.chronoTimer = 180; 
                this.chronoCooldown = 600; 
                FX.boom(this.x, this.y, 20, '#00f1ff');
            }
            if(this.chronoActive) {
                timeScale = 0.4; 
                this.chronoTimer -= 1; 
                if(this.chronoTimer % 5 === 0) FX.part(this.x+15, this.y+15, 1, '#00f1ff');
                if(this.chronoTimer <= 0) this.chronoActive = false;
            }
            if(this.chronoCooldown > 0) this.chronoCooldown -= 1; 
        }
        
        let scaledDt = dt * timeScale;
        if(Math.abs(this.vx) > 0.1) Save.stats.distance += (Math.abs(this.vx) * scaledDt) / 100;

        let l = In.k['ArrowLeft']||In.k['KeyA'];
        let r = In.k['ArrowRight']||In.k['KeyD'];
        let j = In.k['ArrowUp']||In.k['Space']||In.k['KeyW'];
        let d = In.k['ShiftLeft']||In.k['KeyK']||In.k['KeyX']; 
        let s = In.k['ArrowDown']||In.k['KeyS']; 
        
        if(this.dCool>0) this.dCool -= scaledDt;
        if(this.invincible>0) this.invincible -= scaledDt;
        
        if(d && this.dCool<=0 && Save.ups.dash) {
            this.dTime=10; this.dCool=45; this.invincible=15;
            let dir = this.vx !== 0 ? Math.sign(this.vx) : (r ? 1 : -1);
            if(l) dir = -1; if(r) dir = 1;
            this.vx = dir * CFG.DASH; this.vy = 0;
            shake = 8; FX.boom(this.x, this.y, 10, '#00f1ff');
            updateDaily("dashes");
        }
        
        if(this.dTime>0) {
            this.dTime -= scaledDt; this.x += this.vx * scaledDt;
            if(this.dTime<=0) this.vx *= 0.5;
            col(true); return;
        }

        let acc = CFG.ACC * scaledDt;
        if(l) this.vx -= acc;
        if(r) this.vx += acc;
        
        let fric = this.ground ? CFG.FRIC : CFG.AIR_FRIC;
        if(!l && !r) this.vx *= Math.pow(fric, scaledDt);
        
        let maxS = CFG.MAX_S;
        this.vx = Math.max(-maxS, Math.min(maxS, this.vx));
        
        if(Save.ups.sonic && Math.abs(this.vx) > CFG.MAX_S * 0.95 && frame%10===0) {
            FX.part(this.x, this.y, 1, '#fff'); this.invincible = 2; 
        }
        
        let climbing = false;
        if(this.wall !== 0 && !this.ground) { 
             if(this.vy > 0) this.vy = Math.min(this.vy, CFG.WALL_SLIDE);
             if(Save.ups.climb && ((this.wall===1 && r) || (this.wall===-1 && l))) {
                 this.vy = -3; climbing = true;
             }
        }
        
        if(!climbing) {
            if(Save.ups.glider && j && this.vy > 0) {
                this.vy += CFG.G * 0.3 * scaledDt; 
                if(this.vy > 4) this.vy = 4; 
                if(frame%5==0) FX.part(this.x+15, this.y+30, 1, '#fff');
            } 
            else if(Save.ups.stomp && s && !this.ground) {
                this.vy += 2 * scaledDt; FX.part(this.x+15, this.y, 1, '#ff0055');
            }
            else { this.vy += CFG.G * scaledDt; }
            if(this.vy > CFG.MAX_G) this.vy = CFG.MAX_G; 
            if(this.wall !== 0 && this.vy > 0) this.vy = Math.min(this.vy, CFG.WALL_SLIDE); 
        }
        
        if(this.coyote > 0) this.coyote -= scaledDt;
        if(this.buffer > 0) this.buffer -= scaledDt;
        
        if(j && !In.prevK['ArrowUp'] && !In.prevK['Space'] && !In.prevK['KeyW']) this.buffer = CFG.BUFFER;
        
        if(this.buffer > 0) {
            let jumped = false;
            if(this.wall !== 0 && !this.ground) { 
                this.vy = CFG.WALL_JUMP.y;
                this.vx = -this.wall * CFG.WALL_JUMP.x;
                jumped = true;
            } else if(this.ground || this.coyote > 0) { 
                this.vy = CFG.JUMP; jumped = true;
            } else if(this.jumps > 0) { 
                this.vy = CFG.JUMP; this.jumps--; jumped = true;
                FX.boom(this.x, this.y+30, 5, '#fff');
            }
            if(jumped) {
                this.buffer = 0; this.coyote = 0; this.ground = false;
                FX.part(this.x+15, this.y+30, 5, '#fff');
                Save.stats.jumps++;
                updateDaily("jumps");
            }
        }
        
        if(!j && this.vy < -5) this.vy *= 0.6;

        this.x += this.vx * scaledDt; col(true);
        this.y += this.vy * scaledDt; col(false);
        
        if(this.ground) {
            this.coyote = CFG.COYOTE;
            this.jumps = Save.ups.double ? 1 : 0;
        }
        
        this.wall = 0;
        if(!this.ground) {
            if(isSolid(this.x-2, this.y)) this.wall = -1;
            if(isSolid(this.x+32, this.y)) this.wall = 1;
        }
        
        if(this.y > map.h * CFG.TILE + 200) die();
    },
    
    draw() {
        if(this.dead) return;
        
        // --- DRAW PLAYER ---
        if(Math.abs(this.vx) > 8) {
            ctx.globalAlpha = 0.3; ctx.fillStyle = '#fff';
            ctx.fillRect(this.x - this.vx*0.5, this.y - this.vy*0.5, 30, 30);
            ctx.globalAlpha = 1;
        }

        ctx.save();
        
        let sx=0, sy=0;
        if(Math.abs(this.vy)>10) { sx=-4; sy=4; }
        if(Math.abs(this.vx)>8) { sx=4; sy=-2; }
        
        ctx.translate(this.x+15, this.y+15);
        
        // RENDER SKIN
        if (Save.skin === 999) { // CUSTOM PIXEL GRID
             let pixels = Save.customSkin.pixels;
             let size = (30+sx)/6; // 6x6 grid
             for(let i=0; i<36; i++) {
                 let col = i%6; let row = Math.floor(i/6);
                 ctx.fillStyle = pixels[i];
                 ctx.fillRect(-15-sx/2 + col*size, -15-sy + row*size, size+0.5, size+0.5); // +0.5 to fix subpixel gaps
             }
        } else {
             let s = DB.skins[Save.skin];
             ctx.fillStyle = this.invincible > 0 ? '#fff' : s.c;
             if(this.chronoActive) ctx.fillStyle = '#fff'; 
             if(s.glow) { ctx.shadowBlur=20; ctx.shadowColor=s.c; }
             
             ctx.fillRect(-15-sx/2, -15-sy, 30+sx, 30+sy);
             if(s.b) {
                ctx.strokeStyle = s.b; ctx.lineWidth=3;
                ctx.strokeRect(-15-sx/2, -15-sy, 30+sx, 30+sy);
             }
        }

        // EYES
        ctx.fillStyle = Save.light ? "#333" : "#fff";
        if(Save.light && (Save.skin === 0 || Save.skin === 999)) ctx.fillStyle = "#fff";
        
        let lx = 0; 
        if(this.vx > 1) lx = 4; else if(this.vx < -1) lx = -4;
        
        if(frame % 150 < 10) {
            ctx.fillRect(-8 + lx, -5, 6, 2);
            ctx.fillRect(2 + lx, -5, 6, 2);
        } else {
            ctx.fillRect(-10, -8, 8, 8);
            ctx.fillRect(2, -8, 8, 8);
            ctx.fillStyle = "#000";
            ctx.fillRect(-8 + lx*0.5, -6, 4, 4);
            ctx.fillRect(4 + lx*0.5, -6, 4, 4);
        }

        ctx.restore();
        ctx.shadowBlur=0;
    }
};

var _seed = 1;
function rand() { _seed = (_seed * 9301 + 49297) % 233280; return _seed / 233280; }
function setSeed(s) { _seed = s; }

function isSolid(x,y) {
    let tx = Math.floor(x/CFG.TILE), ty = Math.floor(y/CFG.TILE);
    if(ty<0) return false;
    if(currentMode === MODE.ENDLESS && tx >= endX - 50) genEndless();
    if(tx<0||tx>=map.w||ty>=map.h) return false;
    return map.d[ty][tx]===1;
}

function col(axisX) {
    let tiles = [];
    let startX = Math.floor(P.x / CFG.TILE), endX = Math.floor((P.x + P.w - 0.1) / CFG.TILE);
    let startY = Math.floor(P.y / CFG.TILE), endY = Math.floor((P.y + P.h - 0.1) / CFG.TILE);

    for(let y=startY; y<=endY; y++) {
        for(let x=startX; x<=endX; x++) {
            if(y>=0 && y<map.h && x>=0 && x<map.w) {
                if(map.d[y][x] === 1) tiles.push({x:x*CFG.TILE, y:y*CFG.TILE});
            }
        }
    }

    for(let t of tiles) {
        if(axisX) {
            if(P.vx > 0) { P.x = t.x - P.w; P.vx = 0; }
            else if(P.vx < 0) { P.x = t.x + CFG.TILE; P.vx = 0; }
        } else {
            if(P.vy > 0) { P.y = t.y - P.h; P.vy = 0; P.ground = true; }
            else if(P.vy < 0) { P.y = t.y + CFG.TILE; P.vy = 0; }
        }
    }
    
    let cx = P.x + 15, cy = P.y + 15;
    let tx = Math.floor(cx/CFG.TILE), ty = Math.floor(cy/CFG.TILE);
    if(ty>=0 && ty<map.h && tx>=0 && tx<map.w) {
        let t = map.d[ty][tx];
        if(t===2) die();
        if(t===3 && currentMode !== MODE.ENDLESS) win();
        if(t===4) { P.vy = -25; FX.boom(P.x, P.y+20, 10, '#a0f'); }
    }
}

function die() {
    if(P.dead || P.invincible>0) return;
    P.dead = true; shake = 20; Save.stats.deaths++; 
    currentStreak = 0; updateStreakUI();
    updateDaily("deaths");
    
    deathsInLevel++;
    if(deathsInLevel >= 5 && currentMode !== MODE.ENDLESS) {
        document.getElementById('hud-skip').style.display = 'block';
    }
    
    save();
    FX.boom(P.x, P.y, 30, '#fff');
    setTimeout(() => {
        if(currentMode === MODE.ENDLESS) showEndlessMenu();
        else startGame(Save.level, currentMode); 
    }, 400); 
}

function showEndlessMenu() {
    document.getElementById('ui').style.display='none'; 
    let m = document.getElementById('endless-menu');
    document.getElementById('endless-score-val').innerText = endlessScore + "m";
    document.getElementById('endless-best-val').innerText = "BEST: " + Save.stats.maxEndless + "m";
    m.style.display = 'flex';
    document.getElementById('ui').style.display='block';
}

function win() {
    if(state === 'WIN') return; 
    state = 'WIN';
    currentStreak++; updateStreakUI();
    updateDaily("levels");
    deathsInLevel = 0; 
    
    let duration = gameTimer;
    
    if(Save.level >= Save.maxLvl) { Save.maxLvl++; Save.money+=200; }
    else Save.money += 50; 
    save();

    // Check game completion
    if(Save.maxLvl >= CFG.MAX_LEVELS) {
        showVictoryMenu();
        return;
    }
    
    if(currentMode === MODE.TIME) {
        let isRecord = false;
        if(!Save.times[Save.level] || duration < Save.times[Save.level]) {
            Save.times[Save.level] = duration;
            isRecord = true;
        }
        save();
        showWinMenu(duration, isRecord);
    } else {
        setTimeout(() => startGame(Save.level+1, currentMode), 300);
    }
}

function updateDaily(type) {
    Save.daily.tasks.forEach(t => {
        if(t.c) return;
        let def = DAILY_DEFS.find(d => d.id === t.id);
        if(def && def.stat === type) {
            t.p++;
            if(t.p >= def.goal) {
                t.c = true;
                Save.money += def.r;
                FX.text(P.x, P.y-50, "CHALLENGE COMPLETE!");
            }
        }
    });
}

function showWinMenu(time, isRecord) {
    let m = document.getElementById('win-menu');
    let rec = document.getElementById('win-new-record');
    
    rec.style.display = isRecord ? 'block' : 'none';
    document.getElementById('win-level-num').innerText = "LEVEL " + (Save.level + 1) + " COMPLETE";
    
    let ms = Math.floor((time % 1000) / 10);
    let s = Math.floor((time / 1000) % 60);
    let min = Math.floor(time / 60000);
    let tStr = (min<10?"0"+min:min) + ":" + (s<10?"0"+s:s) + ":" + (ms<10?"0"+ms:ms);
    
    document.getElementById('win-time-val').innerText = tStr;
    m.style.display = 'flex';
}

function showVictoryMenu() {
    let m = document.getElementById('victory-menu');
    document.getElementById('vic-death').innerText = Save.stats.deaths;
    
    let totalTime = 0;
    Object.values(Save.times).forEach(v => totalTime += v);
    document.getElementById('vic-time').innerText = (totalTime/1000).toFixed(0) + "s";
    
    document.getElementById('vic-skip').innerText = Save.skipped.length;
    m.style.display = 'flex';
}

function updateStreakUI() {
    let el = document.getElementById('hud-streak');
    if(currentStreak > 1 && currentMode !== MODE.ENDLESS) {
        el.style.display = 'flex';
        document.getElementById('val-streak').innerText = currentStreak;
    } else {
        el.style.display = 'none';
    }
}

// --- GENERATOR ---
function genLevel(n) {
    setSeed((n + 1) * 7392);
    let progress = Math.min(1.0, n / 299); 
    let w = 60 + n*4; let h = 25;
    let d = Array(h).fill(0).map(()=>Array(w).fill(0));
    let o = [];
    
    for(let x=0; x<w; x++) { d[0][x]=1; d[h-1][x]=2; } 
    for(let y=0; y<h; y++) { d[y][0]=1; d[y][w-1]=1; }
    
    let cx = 3, cy = h-5;
    for(let i=0; i<5; i++) d[cy][i] = 1; 
    
    while(cx < w-5) {
        let baseLen = 8 - Math.floor(progress * 6); 
        let len = Math.max(2, baseLen + Math.floor(rand()*3)); 
        let dy = Math.floor(rand()*7) - 3;
        cy += dy; cy = Math.max(5, Math.min(h-5, cy));
        let baseGap = 2 + Math.floor(progress * 5); 
        let gap = baseGap + Math.floor(rand() * 2);
        if (n < 5) gap = Math.min(3, gap);
        if (n < 20) gap = Math.min(4, gap);
        cx += gap;
        for(let i=0; i<len; i++) {
            if(cx+i < w-2) {
                d[cy][cx+i] = 1;
                let spikeChance = n < 10 ? 0 : (0.1 + progress * 0.5);
                if(rand() < spikeChance && i>0 && i<len-1) d[cy-1][cx+i] = 2; 
                if(rand()>0.95 && i>0) d[cy-1][cx+i] = 4; 
                if(rand()>0.7) o.push({x:(cx+i)*CFG.TILE+20, y:(cy-2)*CFG.TILE+20}); 
            }
        }
        cx += len;
    }
    d[cy-1][w-3]=3; d[cy][w-3]=1; 
    return {w, h, d, o};
}

function genEndless(init) {
    if(!init) {
        let add = 200; map.w += add;
        for(let y=0; y<map.h; y++) map.d[y] = map.d[y].concat(Array(add).fill(0));
    }
    let start = endX; let end = start + (init ? 50 : 200);
    for(let x=start; x<end; x++) {
        map.d[0][x] = 1; map.d[map.h-1][x] = 2; 
        if(Math.random() > 0.2) { 
            let h = Math.floor(Math.random()*15)+5;
            map.d[h][x] = 1;
            if(Math.random()>0.8) map.o.push({x:x*40+20, y:(h-1)*40+20});
            if(Math.random()>0.9) map.d[h-1][x] = 2; 
            if(Math.random()>0.98) map.d[h-1][x] = 4; 
        }
    }
    endX = end;
}

// --- LOOP ---
function startGame(n, mode) {
    currentMode = mode;
    paused = false;
    document.getElementById('pause-menu').style.display = 'none';
    document.getElementById('win-menu').style.display = 'none';
    document.getElementById('endless-menu').style.display = 'none';
    document.getElementById('victory-menu').style.display = 'none';
    
    if (deathsInLevel >= 5 && currentMode !== MODE.ENDLESS) {
         document.getElementById('hud-skip').style.display = 'block';
    } else {
         document.getElementById('hud-skip').style.display = 'none';
    }
    
    if(currentMode !== MODE.ENDLESS) {
        if(n >= CFG.MAX_LEVELS) n=0; 
        Save.level = n;
        map = genLevel(n);
        P.reset(80, (map.h-5)*CFG.TILE - 100);
        document.getElementById('prog-container').style.display = 'block';
    } else {
        isEndless = true; endX = 0; endlessScore = 0;
        map = {w:1000, h:25, d:Array(25).fill(0).map(()=>Array(1000).fill(0)), o:[]};
        for(let x=0; x<20; x++) { map.d[0][x]=1; map.d[20][x]=1; } 
        genEndless(true);
        P.reset(100, 400);
        document.getElementById('prog-container').style.display = 'none';
        currentStreak = 0; deathsInLevel = 0;
    }
    
    startTime = Date.now();
    gameTimer = 0; 
    parts=[]; texts=[]; state='PLAY';
    document.getElementById('ui').style.display='block';
    document.getElementById('menu').classList.remove('active');
    
    let lvlBox = document.getElementById('hud-lvl-box');
    let scoreBox = document.getElementById('hud-score');
    let timerBox = document.getElementById('hud-timer');
    
    lvlBox.style.display = 'none';
    scoreBox.style.display = 'none';
    timerBox.style.display = 'none'; 
    updateStreakUI();
    
    if(currentMode === MODE.NORMAL) {
        lvlBox.style.display = 'flex';
        document.getElementById('val-level').innerText = n+1;
    } else if (currentMode === MODE.TIME) {
        lvlBox.style.display = 'flex';
        document.getElementById('val-level').innerText = n+1;
        timerBox.style.display = 'flex'; 
    } else if (currentMode === MODE.ENDLESS) {
        scoreBox.style.display = 'flex';
    }
    
    let ol = document.getElementById('start-overlay');
    ol.style.opacity = 1;
    ol.style.transform = "translate(-50%, -50%) scale(1)";
    setTimeout(() => {
        ol.style.opacity = 0;
        ol.style.transform = "translate(-50%, -50%) scale(1.5)";
    }, 800);
    
    if(!window.looping) { 
        window.looping=true; 
        lastTime = performance.now();
        requestAnimationFrame(loop); 
    }
}

function loop(timestamp) {
    let dt = (timestamp - lastTime) / 16.666; 
    if (dt > 2) dt = 2; 
    lastTime = timestamp;
    update(dt);
    draw();
    requestAnimationFrame(loop);
}

function checkChallenges() {
    DB.challenges.forEach(c => {
        if(!Save.chals.includes(c.id)) {
            let val = Save.stats[c.stat];
            if(val >= c.goal) {
                Save.chals.push(c.id); Save.money += c.r;
                document.getElementById('chal-name').innerText = c.n + " (+" + c.r + ")";
                let pop = document.getElementById('chal-pop');
                pop.classList.add('show');
                setTimeout(()=>pop.classList.remove('show'), 3000);
            }
        }
    });
}

function update(dt) {
    if(state!=='PLAY' || paused) return;
    
    frame++;
    
    if(currentMode === MODE.ENDLESS) {
        let dist = Math.floor(P.x / 100);
        if(dist > endlessScore) {
            endlessScore = dist;
            document.getElementById('hud-score').innerText = dist + "m";
            if(dist > Save.stats.maxEndless) Save.stats.maxEndless = dist;
        }
    } else {
        let p = (P.x / (map.w * CFG.TILE)) * 100;
        document.getElementById('prog-bar').style.width = Math.min(100, Math.max(0, p)) + '%';
    }
    
    let timeScale = P.chronoActive ? 0.4 : 1.0;
    
    if(currentMode === MODE.TIME) {
        gameTimer += dt * 16.666 * timeScale;
        let t = gameTimer;
        let ms = Math.floor((t % 1000) / 10);
        let s = Math.floor((t / 1000) % 60);
        let m = Math.floor(t / 60000);
        document.getElementById('hud-timer').innerText = 
            (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s) + ":" + (ms<10?"0"+ms:ms);
    }
    
    P.update(dt);
    
    let targetX = P.x - cvs.width * 0.3;
    let targetY = P.y - cvs.height * 0.5;
    cam.x += (targetX - cam.x) * 0.1;
    cam.y += (targetY - cam.y) * 0.1;
    cam.x = Math.max(0, Math.min(cam.x, map.w*CFG.TILE - cvs.width));
    cam.y = Math.max(0, Math.min(cam.y, map.h*CFG.TILE - cvs.height));
    
    for(let i=map.o.length-1; i>=0; i--) {
        let o = map.o[i];
        let dx = P.x+15 - o.x, dy = P.y+15 - o.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < 30 || (Save.ups.magnet && dist < 100)) {
            if(Save.ups.magnet && dist > 30) {
                o.x += dx/dist * 5 * dt; o.y += dy/dist * 5 * dt;
            } else {
                map.o.splice(i, 1);
                Save.money += 10; Save.stats.coins++;
                updateDaily("coins");
                FX.part(o.x, o.y, 5, '#ffe900');
                FX.text(o.x, o.y - 20, "+10"); 
            }
        }
    }
    
    if(shake>0) shake -= dt;
    checkChallenges();
}

function draw() {
    let light = Save.light;
    // Dynamic BG
    if (Save.bg === 0) { // Classic
        bgCtx.fillStyle = light ? '#e0e5ec' : '#05070a';
        bgCtx.fillRect(0, 0, bgCvs.width, bgCvs.height);
        bgCtx.strokeStyle = light ? 'rgba(0, 119, 204, 0.1)' : 'rgba(0, 241, 255, 0.1)';
        bgCtx.lineWidth = 2;
        bgCtx.beginPath();
        let gx = -(cam.x % 100); let gy = -(cam.y % 100);
        for(let i=0; i<bgCvs.width/100+1; i++) { bgCtx.moveTo(gx+i*100, 0); bgCtx.lineTo(gx+i*100, bgCvs.height); }
        for(let i=0; i<bgCvs.height/100+1; i++) { bgCtx.moveTo(0, gy+i*100); bgCtx.lineTo(bgCvs.width, gy+i*100); }
        bgCtx.stroke();
    } 
    else if (Save.bg === 1) { // Grid
        bgCtx.fillStyle = light ? '#f0f0f0' : '#10051a';
        bgCtx.fillRect(0, 0, bgCvs.width, bgCvs.height);
        bgCtx.strokeStyle = light ? 'rgba(255,0,0,0.1)' : 'rgba(255, 0, 85, 0.2)';
        bgCtx.lineWidth = 1;
        bgCtx.beginPath();
        let gx = -(cam.x % 40); let gy = -(cam.y % 40);
        for(let i=0; i<bgCvs.width/40+1; i++) { bgCtx.moveTo(gx+i*40, 0); bgCtx.lineTo(gx+i*40, bgCvs.height); }
        for(let i=0; i<bgCvs.height/40+1; i++) { bgCtx.moveTo(0, gy+i*40); bgCtx.lineTo(bgCvs.width, gy+i*40); }
        bgCtx.stroke();
    }
    else if (Save.bg === 2) { // Starfield
        bgCtx.fillStyle = light ? '#fff' : '#000';
        bgCtx.fillRect(0, 0, bgCvs.width, bgCvs.height);
        bgCtx.fillStyle = light ? '#aaa' : '#fff';
        for(let i=0; i<50; i++) {
            let x = ((i*123 + cam.x*0.5) % bgCvs.width);
            let y = ((i*456 + cam.y*0.5) % bgCvs.height);
            bgCtx.fillRect(x,y,2,2);
        }
    }
    else if (Save.bg === 3) { // Sunset
        let grad = bgCtx.createLinearGradient(0,0,0,bgCvs.height);
        if(light) { grad.addColorStop(0, '#ffd700'); grad.addColorStop(1, '#ff8800'); }
        else { grad.addColorStop(0, '#200530'); grad.addColorStop(1, '#601040'); }
        bgCtx.fillStyle = grad;
        bgCtx.fillRect(0, 0, bgCvs.width, bgCvs.height);
    }

    ctx.clearRect(0,0,cvs.width,cvs.height);
    ctx.save();
    let sx = (Math.random()-0.5)*shake; let sy = (Math.random()-0.5)*shake;
    ctx.translate(-cam.x + sx, -cam.y + sy);
    
    let minX=Math.floor(cam.x/CFG.TILE), maxX=minX+Math.floor(cvs.width/CFG.TILE)+2;
    let minY=Math.floor(cam.y/CFG.TILE), maxY=minY+Math.floor(cvs.height/CFG.TILE)+2;
    
    for(let y=minY; y<=maxY; y++) {
        for(let x=minX; x<=maxX; x++) {
            if(y>=0&&y<map.h && x>=0&&x<map.w) {
                let t=map.d[y][x];
                if(t>0) {
                    let tx = x*CFG.TILE, ty = y*CFG.TILE;
                    if(t===1) {
                        ctx.fillStyle = light ? '#555' : '#111'; 
                        ctx.strokeStyle= light ? '#333' : '#333'; ctx.lineWidth=2;
                        ctx.fillRect(tx, ty, CFG.TILE, CFG.TILE);
                        ctx.strokeRect(tx, ty, CFG.TILE, CFG.TILE);
                        ctx.fillStyle = light ? 'rgba(0, 119, 204, 0.3)' : 'rgba(0, 241, 255, 0.3)';
                        ctx.fillRect(tx, ty, CFG.TILE, 4);
                    }
                    if(t===2) {
                        ctx.fillStyle= light ? '#d90048' : '#f05';
                        ctx.beginPath(); ctx.moveTo(tx, ty+40); ctx.lineTo(tx+20, ty); ctx.lineTo(tx+40, ty+40); ctx.fill();
                    }
                    if(t===3) {
                        ctx.fillStyle='#0f0'; ctx.globalAlpha=0.5 + Math.sin(frame/10)*0.5;
                        ctx.fillRect(tx, ty, 40, 40); ctx.globalAlpha=1;
                    }
                    if(t===4) {
                        ctx.fillStyle='#a0f'; ctx.fillRect(tx, ty+30, 40, 10);
                    }
                }
            }
        }
    }
    
    ctx.fillStyle = '#ffe900';
    for(let o of map.o) {
        ctx.beginPath(); ctx.arc(o.x, o.y, 8 + Math.sin(frame/5)*2, 0, Math.PI*2); ctx.fill();
    }
    
    for(let i=parts.length-1; i>=0; i--) {
        let p = parts[i];
        p.x += p.vx * p.dt; p.y += p.vy * p.dt; p.l -= p.dt;
        ctx.globalAlpha = p.l/20; ctx.fillStyle = p.c;
        ctx.fillRect(p.x, p.y, p.s, p.s);
        if(p.l<=0) parts.splice(i, 1);
    }
    ctx.globalAlpha = 1;
    
    ctx.font = "bold 16px 'Rajdhani', sans-serif";
    ctx.fillStyle = light ? "#000" : "#fff";
    ctx.textAlign = "center";
    for(let i=texts.length-1; i>=0; i--) {
        let t = texts[i];
        t.y -= 1; t.l -= 1;
        ctx.globalAlpha = Math.min(1, t.l/20);
        ctx.fillText(t.t, t.x, t.y);
        if(t.l<=0) texts.splice(i, 1);
    }
    ctx.globalAlpha = 1;
    
    if(P.chronoActive) {
        ctx.fillStyle = light ? "rgba(0, 0, 0, 0.1)" : "rgba(0, 241, 255, 0.1)";
        ctx.fillRect(cam.x-100, cam.y-100, cvs.width+200, cvs.height+200);
    }

    P.draw();
    ctx.restore();
}

// FX
var FX = {
    part(x,y,n,c) {
        for(let i=0; i<n; i++) parts.push({x:x, y:y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, l:20, c:c, s:Math.random()*4+2, dt:1});
    },
    boom(x,y,n,c) {
        for(let i=0; i<n; i++) parts.push({x:x, y:y, vx:(Math.random()-0.5)*20, vy:(Math.random()-0.5)*20, l:30, c:c, s:Math.random()*8+4, dt:1});
    },
    text(x,y,txt) {
        texts.push({x:x, y:y, t:txt, l:40});
    }
};

// --- MENU SYSTEM ---
var Game = {
    togglePause() {
        if(state !== 'PLAY') return;
        paused = !paused;
        let pm = document.getElementById('pause-menu');
        if(paused) {
            pm.style.display = 'flex';
            pauseTimeStart = Date.now();
        } else {
            pm.style.display = 'none';
            startTime += (Date.now() - pauseTimeStart);
        }
    },
    
    toggleLight() {
        Save.light = !Save.light;
        if(Save.light) document.body.classList.add('light-mode');
        else document.body.classList.remove('light-mode');
        save();
        this.renderMain(); // refresh menu to update buttons style
    },

    menu() {
        state = 'MENU';
        paused = false;
        document.getElementById('ui').style.display='none';
        document.getElementById('pause-menu').style.display='none';
        document.getElementById('win-menu').style.display='none';
        document.getElementById('endless-menu').style.display='none';
        document.getElementById('victory-menu').style.display='none';
        let m = document.getElementById('menu');
        m.classList.add('active');
        this.renderMain();
        save();
    },
    
    nextLevel() {
        deathsInLevel = 0; 
        if (Save.level + 1 >= CFG.MAX_LEVELS) Game.menu();
        else startGame(Save.level + 1, currentMode);
    },
    
    retryLevel() {
        startGame(Save.level, currentMode);
    },
    
    skipLevel() {
        if(Save.level >= Save.maxLvl) { 
            Save.maxLvl++; 
            if(!Save.skipped.includes(Save.level)) Save.skipped.push(Save.level);
        }
        save();
        this.nextLevel();
    },
    
    downloadStats() {
        let t = `NEON LEAP 20.0 STATS\n------------------\nLevels: ${Save.maxLvl}/${CFG.MAX_LEVELS}\nDeaths: ${Save.stats.deaths}\nCoins: ${Save.stats.coins}\nDistance: ${Save.stats.distance.toFixed(0)}m\nSkipped Levels: ${Save.skipped.length}\nTime Trial Records:\n`;
        for(let i=0; i<CFG.MAX_LEVELS; i++) {
            if(Save.times[i]) t += `Level ${i+1}: ${(Save.times[i]/1000).toFixed(2)}s\n`;
        }
        let b = new Blob([t], {type: 'text/plain'});
        let a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'neon_leap_stats.txt';
        a.click();
    },
    
    renderMain() {
        let h = `
            <button class="theme-toggle" id="theme-btn" onclick="Game.toggleLight()" title="Toggle Light Mode">‚òÄ</button>
            <h1>NEON <span>LEAP</span></h1>
            <h2>ULTIMATE STATS</h2>
            
            <div class="mode-select">
                <div class="mode-card" onclick="Game.renderLevels(MODE.NORMAL)">
                    <h3>ADVENTURE</h3>
                    <p>Relaxed pace. No visible timer.</p>
                </div>
                <div class="mode-card" onclick="Game.renderLevels(MODE.TIME)">
                    <h3>TIME TRIAL</h3>
                    <p>Race against the clock. Set Records.</p>
                </div>
                <div class="mode-card" onclick="startGame(0, MODE.ENDLESS)">
                    <h3>ENDLESS</h3>
                    <p>One life. Infinite distance.</p>
                </div>
            </div>

            <button class="btn btn-primary" onclick="Game.renderStats()">PROFILE & STATS</button>
            <button class="btn btn-rare" onclick="Game.renderShop()">SHOP</button>
            <button class="btn" onclick="Game.renderChal()">CHALLENGES</button>
        `;
        document.getElementById('menu-content').innerHTML = h;
    },

    renderLevels(targetMode) {
        let h = `<h2>SELECT LEVEL (${targetMode === MODE.TIME ? "TIME TRIAL" : "ADVENTURE"})</h2><div class="level-grid">`;
        for(let i=0; i<CFG.MAX_LEVELS; i++) {
            let u = i <= Save.maxLvl;
            let isSkipped = Save.skipped.includes(i);
            let c = i < Save.maxLvl ? (isSkipped ? 'skipped' : 'completed') : '';
            let t = "";
            if(targetMode === MODE.TIME && Save.times[i]) {
                let ms = Save.times[i];
                t = `<div class="lvl-time">${(ms/1000).toFixed(2)}s</div>`;
            } else if (targetMode === MODE.TIME && u) {
                t = `<div class="lvl-time">--:--</div>`;
            }
            let cl = u ? `unlocked ${c}` : '';
            let clk = u ? `onclick="deathsInLevel=0; startGame(${i}, ${targetMode})"` : '';
            h += `<div class="lvl-btn ${cl}" ${clk}><div class="lvl-num">${i+1}</div>${t}</div>`;
        }
        h += `</div><button class="btn" onclick="Game.renderMain()">BACK</button>`;
        document.getElementById('menu-content').innerHTML = h;
    },
    
    renderStats() {
        let s = Save.stats;
        let totalTime = 0;
        Object.values(Save.times).forEach(v => totalTime += v);
        let timeFormatted = (totalTime/1000).toFixed(1) + "s";
        let recs = "";
        let count = 0;
        for(let i=0; i<CFG.MAX_LEVELS; i++) {
            if(Save.times[i]) {
                recs += `<div class="record-item"><span>LEVEL ${i+1}</span> <span>${(Save.times[i]/1000).toFixed(3)}s</span></div>`;
                count++;
            }
        }
        if(count===0) recs = "<div style='color:#666; font-style:italic;'>No Time Trial records set yet.</div>";

        let h = `
            <div class="stats-container">
                <div class="stats-header">
                    <h2>PLAYER PROFILE</h2>
                    <h3 style="color:var(--c-primary)">RANK: ${Save.maxLvl > 50 ? 'S' : (Save.maxLvl > 20 ? 'A' : 'B')}</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-card highlight"><div class="stat-val">${Save.maxLvl} / ${CFG.MAX_LEVELS}</div><div class="stat-label">Levels Cleared</div></div>
                    <div class="stat-card"><div class="stat-val">${s.distance.toFixed(0)}m</div><div class="stat-label">Distance Run</div></div>
                    <div class="stat-card"><div class="stat-val" style="color:var(--c-danger)">${s.deaths}</div><div class="stat-label">Total Deaths</div></div>
                    <div class="stat-card"><div class="stat-val" style="color:var(--c-accent)">${s.coins}</div><div class="stat-label">Coins Collected</div></div>
                    <div class="stat-card"><div class="stat-val">${s.maxEndless}m</div><div class="stat-label">Best Endless Run</div></div>
                    <div class="stat-card"><div class="stat-val">${timeFormatted}</div><div class="stat-label">Total Speedrun Time</div></div>
                </div>
                <h3>TIME TRIAL RECORDS</h3>
                <div class="records-list">${recs}</div>
            </div>
            <br>
            <button class="btn" onclick="Game.renderMain()">BACK</button>
        `;
        document.getElementById('menu-content').innerHTML = h;
    },
    
    renderShop() {
        let h = `
        <div class="shop-container">
            <div style="text-align:right; font-size:1.5rem; margin-bottom:10px; color:var(--c-accent); font-weight:bold;">BALANCE: <span id="shop-balance">${Save.money}</span> ‚Ç≥</div>
            <div class="shop-nav">
                <button class="shop-tab active" id="tab-skin" onclick="Game.switchShop('skin')">SKINS</button>
                <button class="shop-tab" id="tab-up" onclick="Game.switchShop('up')">UPGRADES</button>
                <button class="shop-tab" id="tab-bg" onclick="Game.switchShop('bg')">SCENES</button>
                <button class="shop-tab" id="tab-custom" onclick="Game.switchShop('custom')">STUDIO üé®</button>
            </div>
            <div class="coupon-area">
                <input type="text" id="coupon-in" class="coupon-input" placeholder="ENTER CODE">
                <button class="coupon-btn" onclick="Game.redeemCode()">REDEEM</button>
            </div>
            <div class="shop-grid" id="shop-grid"></div>
        </div>
        <button class="btn" onclick="Game.renderMain()">BACK</button>`;
        document.getElementById('menu-content').innerHTML = h;
        document.getElementById('menu-content').scrollTop = 0;
        this.switchShop('skin');
    },
    
    redeemCode() {
        let code = document.getElementById('coupon-in').value.toUpperCase().trim();
        let valid = { "NEON2024": 1000, "START": 500, "SPEED": 300, "JUMP": 300, "LD_15": 1000000000 };
        if(Save.codes.includes(code)) { alert("Code already used!"); return; }
        if(valid[code]) {
            Save.codes.push(code); Save.money += valid[code];
            alert("Redeemed: " + (valid[code] > 100000 ? "UNLIMITED POWER!" : valid[code] + " Coins!"));
            save(); Game.renderShop();
        } else alert("Invalid Code");
    },
    
    switchShop(type) {
        document.querySelectorAll('.shop-tab').forEach(e=>e.classList.remove('active'));
        let tab = document.getElementById('tab-'+type);
        if(tab) tab.classList.add('active');
        
        let g = document.getElementById('shop-grid');
        let h = "";
        
        if(type==='skin') {
            if(Save.ups.customizer) {
                let sel = Save.skin === 999;
                h += `<div class="shop-card ${sel?'selected':''}">
                    <div class="card-preview" style="background:#333; border:2px solid #fff; display:grid; grid-template-columns:repeat(6,1fr);"></div>
                    <div style="font-weight:bold; color:var(--c-primary)">MY PIXEL SKIN</div>
                    ${sel ? '<button class="card-btn">EQUIPPED</button>' : '<button class="card-btn" onclick="Game.buySkin(999)">EQUIP</button>'}
                </div>`;
            }
            DB.skins.forEach((s, i) => {
                let owned = Save.skins.includes(i);
                let sel = Save.skin === i;
                let btn = owned 
                    ? (sel ? '<button class="card-btn">EQUIPPED</button>' : `<button class="card-btn" onclick="Game.buySkin(${i})">EQUIP</button>`)
                    : `<button class="card-btn buy" onclick="Game.buySkin(${i})">BUY ${s.p}</button>`;
                h += `
                <div class="shop-card ${owned?'owned':''} ${sel?'selected':''}">
                    <div class="card-preview" style="background:${s.c}; border:${s.b?'2px solid '+s.b:'none'}; box-shadow:${s.glow?'0 0 15px '+s.c:'none'}"></div>
                    <div style="font-weight:bold; color:var(--c-primary)">${s.n}</div>
                    ${btn}
                </div>`;
            });
        } 
        else if(type==='up') {
            DB.upgrades.forEach(u => {
                let owned = Save.ups[u.id];
                let btn = owned ? '<button class="card-btn">OWNED</button>' : `<button class="card-btn buy" onclick="Game.buyUp('${u.id}')">BUY ${u.p}</button>`;
                h += `
                <div class="shop-card ${owned?'owned':''}">
                    <div class="card-preview" style="color:var(--c-primary); background:#222;">${u.ic || '‚òÖ'}</div>
                    <div style="font-weight:bold; color:var(--c-primary)">${u.n}</div>
                    <div style="font-size:0.8rem; color:#888; margin-top:5px">${u.d}</div>
                    ${btn}
                </div>`;
            });
        }
        else if(type==='bg') {
            DB.backgrounds.forEach(b => {
                let owned = Save.bgs.includes(b.id);
                let sel = Save.bg === b.id;
                let btn = owned 
                    ? (sel ? '<button class="card-btn">EQUIPPED</button>' : `<button class="card-btn" onclick="Game.buyBg(${b.id})">EQUIP</button>`)
                    : `<button class="card-btn buy" onclick="Game.buyBg(${b.id})">BUY ${b.p}</button>`;
                h += `<div class="shop-card ${owned?'owned':''} ${sel?'selected':''}">
                    <div class="card-preview" style="color:var(--c-primary); background:#111;">${b.id+1}</div>
                    <div style="font-weight:bold; color:var(--c-primary)">${b.n}</div>
                    ${btn}
                </div>`;
            });
        }
        else if(type==='custom') {
            if (!Save.ups.customizer) {
                 g.innerHTML = `
                 <div class="studio-locked">
                     <div>ACCESS DENIED</div>
                     <div style="font-size:1rem; margin-top:10px; color:#fff;">DESIGNER LICENSE REQUIRED</div>
                     <button class="btn btn-primary" onclick="Game.buyUp('customizer')" style="margin-top:20px;">BUY LICENSE (50,000)</button>
                 </div>`;
                 return;
            }
            
            // Pixel Art Grid
            let gridHTML = "";
            Save.customSkin.pixels.forEach((col, idx) => {
                 gridHTML += `<div id="px-cell-${idx}" class="pixel-cell" style="background:${col}" onclick="Game.pixelClick(${idx})"></div>`;
            });
            
            // Palette
            let colors = ["#ff0000", "#ff7f00", "#ffff00", "#00ff00", "#0000ff", "#4b0082", "#9400d3", "#ffffff", "#888888", "#000000", "#00f1ff", "#ff0055"];
            let palHTML = "";
            colors.forEach(c => {
                 palHTML += `<div class="color-swatch" style="background:${c}" onclick="Game.setPalette('${c}', this)"></div>`;
            });

            g.innerHTML = `
            <div class="studio-box">
                <div class="studio-header">PIXEL STUDIO v1.0</div>
                <div style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap;">
                    <div style="position:relative;">
                         <div class="pixel-grid">
                            <!-- EYES OVERLAY -->
                            <div class="eye-guide" style="top:25%; left:12%; width:15%; height:10%;"></div>
                            <div class="eye-guide" style="top:25%; right:12%; width:15%; height:10%;"></div>
                            ${gridHTML}
                         </div>
                         <div style="text-align:center; font-size:0.8rem; color:#aaa; margin-top:5px;">CANVAS</div>
                    </div>
                    <div style="width:200px;">
                        <div style="margin-bottom:10px; text-align:center;">PALETTE</div>
                        <div class="studio-controls">${palHTML}</div>
                        <div style="margin-top:20px; text-align:center;">SELECTED: <div id="cur-color" style="display:inline-block; width:20px; height:20px; border:1px solid #fff; background:${Game.curColor||'#fff'}"></div></div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn btn-primary" onclick="Game.buySkin(999)" style="margin:0;">SAVE & EQUIP</button>
                </div>
            </div>`;
            return;
        }
        g.innerHTML = h;
    },
    
    curColor: "#ffffff",
    
    setPalette(c, el) {
        Game.curColor = c;
        document.getElementById('cur-color').style.background = c;
        document.querySelectorAll('.color-swatch').forEach(e=>e.classList.remove('active'));
        if(el) el.classList.add('active');
    },
    
    pixelClick(idx) {
        Save.customSkin.pixels[idx] = Game.curColor;
        save();
        // Live update the cell
        let cell = document.getElementById('px-cell-'+idx);
        if(cell) cell.style.background = Game.curColor;
    },
    
    setCustomSkin(key, val) {
        // Legacy support function if needed
        save();
    },
    
    buySkin(id) {
        if(id === 999) { Save.skin = 999; save(); this.switchShop('skin'); return; }
        if(Save.skins.includes(id)) { Save.skin=id; this.switchShop('skin'); return; }
        let s = DB.skins[id];
        if(Save.money >= s.p) {
            Save.money -= s.p; Save.skins.push(id); Save.skin = id;
            this.switchShop('skin'); save();
            document.getElementById('shop-balance').innerText = Save.money;
        }
    },
    
    buyBg(id) {
        if(Save.bgs.includes(id)) { Save.bg=id; this.switchShop('bg'); return; }
        let b = DB.backgrounds.find(x=>x.id===id);
        if(Save.money >= b.p) {
            Save.money -= b.p; Save.bgs.push(id); Save.bg = id;
            this.switchShop('bg'); save();
            document.getElementById('shop-balance').innerText = Save.money;
        }
    },
    
    buyUp(id) {
        if(Save.ups[id]) return;
        let u = DB.upgrades.find(x=>x.id===id);
        if(Save.money >= u.p) {
            Save.money -= u.p; Save.ups[id] = true;
            this.switchShop('up'); save();
            document.getElementById('shop-balance').innerText = Save.money;
            // If customizer bought, refresh to show tab
            if(id==='customizer') Game.renderShop();
        }
    },

    renderChal() {
        // ... (Same logic as before) ...
        let now = new Date();
        let end = new Date(); end.setHours(24,0,0,0);
        let diff = end - now;
        let hLeft = Math.floor(diff/3600000);
        let mLeft = Math.floor((diff%3600000)/60000);
        
        let dailyHTML = "";
        Save.daily.tasks.forEach(task => {
            let def = DAILY_DEFS.find(d => d.id === task.id);
            if(def) {
                let dProg = Math.min(100, (task.p / def.goal) * 100);
                let dDone = task.c;
                dailyHTML += `
                <div class="chal-card ${dDone?'done':''}">
                    <div class="chal-progress-bg"><div class="chal-progress-fill" style="width:${dProg}%"></div></div>
                    <div class="chal-icon-box">${def.ic || 'üìÖ'}</div>
                    <div class="chal-text"><div class="chal-title">DAILY: ${def.n}</div><div class="chal-desc">${def.d}</div></div>
                    <div class="chal-meta"><div class="chal-status">${dDone ? 'CLAIMED' : dProg.toFixed(0)+'%'}</div><div class="chal-reward">+${def.r} ‚Ç≥</div></div>
                </div>`;
            }
        });

        let h = `<h2>CHALLENGES</h2><div style="color:var(--c-primary); margin-bottom:15px; font-weight:bold; font-size:1.2rem;">DAILY RESET IN ${hLeft}H ${mLeft}M</div><div style='width:100%; max-width:800px;'>${dailyHTML}`;
        DB.challenges.forEach(c => {
            let done = Save.chals.includes(c.id);
            let prog = Math.min(100, (Save.stats[c.stat] / c.goal) * 100);
            h += `
            <div class="chal-card ${done?'done':''}">
                <div class="chal-progress-bg"><div class="chal-progress-fill" style="width:${prog}%"></div></div>
                <div class="chal-icon-box">${c.ic || 'üèÜ'}</div>
                <div class="chal-text"><div class="chal-title">${c.n}</div><div class="chal-desc">${c.d}</div></div>
                <div class="chal-meta"><div class="chal-status">${done ? 'COMPLETED' : prog.toFixed(0)+'%'}</div><div class="chal-reward">+${c.r} ‚Ç≥</div></div>
            </div>`;
        });
        h += '</div><br><button class="btn" onclick="Game.renderMain()">BACK</button>';
        document.getElementById('menu-content').innerHTML = h;
    }
};

// Initial Start
In.init();
const fit = () => { cvs.width=bgCvs.width=window.innerWidth; cvs.height=bgCvs.height=window.innerHeight; };
window.addEventListener('resize', fit);
fit();
Game.menu();
</script>
</body>
</html>
